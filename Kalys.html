<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalys Bot</title>
    <link rel="icon" type="image/jpeg" href="images/kalysicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        
        #lang-selector-options li {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #lang-selector-options li:hover {
            background-color: #4b5563; /* gray-600 */
        }
        body {
            font-family: sans-serif;
            background-color: #1f2937; /* Dark background */
            color: #f3f4f6;
        }
        /* Custom scrollbar for chat area (now for the entire scrollable content) */
        #scrollable-content::-webkit-scrollbar {
            width: 8px;
        }
        #scrollable-content::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }
        #scrollable-content::-webkit-scrollbar-track {
            background-color: #1f2937;
        }
        /* Style for the fixed sidebar */
        .sidebar {
            transition: all 0.3s ease-in-out;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Streamlit-like source block styling */
        .source-snippet {
            /* Mimicking a terminal/code look */
            background-color: #1e293b; /* Slate-800 */
            color: #e2e8f0; /* Slate-200 */
            font-family: monospace;
            padding: 8px;
            border-radius: 4px;

            /* == Use 'scroll' to ensure scrollbar is always available when needed. == */
            max-height: 100px;
            overflow-y: scroll;
            /* ====================================================================================== */

            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 0.75rem;
            border: 1px solid #475569; /* Slate-600 */
        }
        .source-snippet::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .source-snippet::-webkit-scrollbar-thumb {
            background-color: #64748b; /* Slate-500 */
            border-radius: 3px;
        }
        .source-snippet::-webkit-scrollbar-track {
            background-color: #1e293b;
        }

    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <div id="sidebar" class="sidebar w-64 p-4 bg-gray-800 text-gray-100 flex flex-col overflow-y-auto">
        <h2 class="text-xl font-bold mb-4">
            <span id="sidebar-header-filter"></span>
        </h2>

        <div class="mb-6 pb-4 border-b border-gray-700 flex-shrink-0">
            <h3 class="text-lg font-semibold mb-2">üåê Language</h3>
            <div id="custom-lang-selector" class="relative">
                <button id="lang-selector-button" type="button" class="w-full p-2 flex items-center bg-gray-700 rounded-lg text-left">
                    </button>
                <ul id="lang-selector-options" class="hidden absolute z-10 w-full mt-1 bg-gray-600 rounded-lg shadow-lg">
                    </ul>
            </div>
        </div>

        <div id="filter-section" class="mb-6 pb-4 border-b border-gray-700 flex-shrink-0">
            <h3 class="text-lg font-semibold mb-2" id="sidebar-header-filter-text"></h3>
            <p class="text-sm text-gray-400 mb-3" id="sidebar-markdown-filter"></p>
            <div id="document-checkboxes" class="space-y-2">
                </div>
            <p id="sidebar-info-searching" class="mt-3 text-sm font-medium text-blue-400"></p>
        </div>

        <div class="mb-6 pb-4 border-b border-gray-700 flex-shrink-0">
            <h3 class="text-lg font-semibold mb-2" id="sidebar-header-retrieval"></h3>
            <label for="k-slider" class="block text-sm font-medium mb-1" id="sidebar-slider-label"></label>
            <input type="range" id="k-slider" min="1" max="10" value="4" step="1" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
            <span id="k-value" class="text-sm text-gray-400 block text-right mt-1">4</span>
        </div>

        <div class="flex-grow pt-4">
            <h3 class="text-lg font-semibold mb-2" id="sidebar-header-downloads"></h3>
            <p class="text-sm text-gray-400 mb-3" id="sidebar-markdown-downloads"></p>
            <div class="space-y-2 text-sm bg-gray-900 p-2 rounded-lg" id="download-buttons">
                </div>
        </div>


    </div>

    <div class="flex-1 flex flex-col">

        <div id="scrollable-content" class="flex-1 overflow-y-auto bg-gray-900">

            <header class="p-6 pb-2 flex justify-center">
                <div class="flex items-center space-x-4 max-w-xl w-full">
                    <img src="images/kalyslogo2-removebg-preview.png" alt="Kalys Logo" class="w-40 h-40 object-contain flex-shrink-0">
                    <div class="bg-white text-gray-800 p-4 rounded-xl rounded-tl-none shadow-xl flex-1 border border-gray-300">
                        <h1 class="text-xl font-extrabold" id="main-title"></h1>
                    </div>
                </div>
            </header>

            <main id="chat-area" class="p-6 pt-0 space-y-4">
                </main>
        </div>

        <div class="p-4 bg-gray-800 shadow-lg flex items-center space-x-3 flex-shrink-0">
            <button id="new-chat-button" class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition duration-150 shadow-md flex-shrink-0 text-sm"></button>

            <input type="text" id="chat-input" class="flex-1 p-3 rounded-xl bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ask a question about laws...">
            <button id="send-button" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition duration-150 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0">
                <span id="send-text">Send</span>
                <div id="loading-spinner" class="loading-spinner hidden"></div>
            </button>
        </div>
    </div>



    <script type="module">
        // --- Language Localization Maps ---
        const LANGUAGE_MAPS = {
            "en": {
                "label": "English",
                "flag": "./images/united-states.png",
                "page_title": "Kalys MVP",
                "main_title": "I am Kalys üëã, a Kyrgyz law assistant bot.",
                "sidebar_header_filter": "Document Filtering (Knowledge Base)",
                "sidebar_markdown_filter": "Select the law codes the engine should search within.",
                "sidebar_info_searching": "Searching across **{count}** documents.",
                "sidebar_header_retrieval": "Retrieval Settings",
                "sidebar_slider_label": "Documents Chunks to Retrieve (k)",
                "sidebar_header_downloads": "Source Downloads",
                "sidebar_markdown_downloads": "These sources might be outdated.",
                "sidebar_check_api": "‚úÖ **Status:** API Keys loaded for frontend calls.",
                "chat_input_placeholder": "Ask a question about laws...",
                "spinner_thinking": "Thinking...",
                "source_expander": "üìù Context Snippets Used for this Answer (Placeholder)",
                "source_label": "Source {j}: {display_name} (Page {display_page})",
                "button_new_chat": "Start New Chat",
                "warning_disclaimer": "‚ö†Ô∏è **Always verify answers with official sources.**",
                "send_text": "Send",
                "api_error_message": "An API error occurred. Please check your API key, network, and browser console for details. (Check the console for 401 Unauthorized errors).",
            },
            "ru": {
                "label": "–†—É—Å—Å–∫–∏–π",
                "flag": "./images/russia.png",
                "page_title": "–ö–∞–ª—ã—Å MVP",
                "main_title": "–Ø –ö–∞–ª—ã—Å üëã, –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –∑–∞–∫–æ–Ω–∞–º –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞.",
                "sidebar_header_filter": "–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –î–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π)",
                "sidebar_markdown_filter": "–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–¥—ã –∑–∞–∫–æ–Ω–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞.",
                "sidebar_info_searching": "–ü–æ–∏—Å–∫ –≤–µ–¥–µ—Ç—Å—è –ø–æ **{count}** –¥–æ–∫—É–º–µ–Ω—Ç–∞–º.",
                "sidebar_header_retrieval": "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–∑–≤–ª–µ—á–µ–Ω–∏—è",
                "sidebar_slider_label": "–ò–∑–≤–ª–µ–∫–∞–µ–º—ã–µ –ß–∞—Å—Ç–∏ –î–æ–∫—É–º–µ–Ω—Ç–æ–≤ (k)",
                "sidebar_header_downloads": "–ó–∞–≥—Ä—É–∑–∫–∞ –ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤",
                "sidebar_markdown_downloads": "–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏.",
                "sidebar_check_api": "‚úÖ **–°—Ç–∞—Ç—É—Å:** –ö–ª—é—á–∏ API –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥-–≤—ã–∑–æ–≤–æ–≤.",
                "chat_input_placeholder": "–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∑–∞–∫–æ–Ω—ã...",
                "spinner_thinking": "–î—É–º–∞—é...",
                "source_expander": "üìù –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ (–ó–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—å)",
                "source_label": "–ò—Å—Ç–æ—á–Ω–∏–∫ {j}: {display_name} (–°—Ç—Ä. {display_page})",
                "button_new_chat": "–ù–∞—á–∞—Ç—å –ù–æ–≤—ã–π –ß–∞—Ç",
                "warning_disclaimer": "‚ö†Ô∏è **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –æ—Ç–≤–µ—Ç—ã –ø–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º.**",
                "send_text": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å",
                "api_error_message": "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ API. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à –∫–ª—é—á API, —Å–µ—Ç—å –∏ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. (–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ 401 Unauthorized).",
            },
            "ky": {
                "label": "–ö—ã—Ä–≥—ã–∑—á–∞",
                "flag": "./images/flag.png",
                "page_title": "–ö–∞–ª—ã—Å MVP",
                "main_title": "–ú–µ–Ω –ö–∞–ª—ã—Å üëã ‚Äî –ö—ã—Ä–≥—ã–∑ –º—ã–π–∑–∞–º–¥–∞—Ä—ã –±–æ—é–Ω—á–∞ –∂–∞—Ä–¥–∞–º—á—ã –±–æ—Ç.",
                "sidebar_header_filter": "–î–æ–∫—É–º–µ–Ω—Ç—Ç–µ—Ä–¥–∏ —á—ã–ø–∫–∞–ª–æ–æ (–ë–∏–ª–∏–º –±–∞–∑–∞—Å—ã)",
                "sidebar_markdown_filter": "–ò–∑–¥”©”© “Ø—á“Ø–Ω –º—ã–π–∑–∞–º –∫–æ–¥–µ–∫—Å—Ç–µ—Ä–∏–Ω —Ç–∞–Ω–¥–∞“£—ã–∑.",
                "sidebar_info_searching": "**{count}** –¥–æ–∫—É–º–µ–Ω—Ç –±–æ—é–Ω—á–∞ –∏–∑–¥”©”©.",
                "sidebar_header_retrieval": "–ò–∑–¥”©”© –ñ”©–Ω–¥”©”©–ª”©—Ä“Ø",
                "sidebar_slider_label": "–ö–∞–Ω—á–∞ –±—É–ª–∞–∫—Ç–∞—Ä–¥—ã —Ç–∞–ø–∫—ã“£—ã–∑ –∫–µ–ª–µ—Ç?",
                "sidebar_header_downloads": "–ë—É–ª–∞–∫—Ç–∞—Ä–¥—ã –ñ“Ø–∫—Ç”©–ø –ê–ª—É—É",
                "sidebar_markdown_downloads": "–ë—É–ª –±—É–ª–∞–∫—Ç–∞—Ä —ç—Å–∫–∏ –±–æ–ª—É—à—É –º“Ø–º–∫“Ø–Ω.",
                "sidebar_check_api": "‚úÖ **–°—Ç–∞—Ç—É—Å:** API –∞—á–∫—ã—á—Ç–∞—Ä—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —á–∞–ª—É—É–ª–∞—Ä—ã “Ø—á“Ø–Ω –∂“Ø–∫—Ç”©–ª–¥“Ø.",
                "chat_input_placeholder": "–ú—ã–π–∑–∞–º–¥–∞—Ä –±–æ—é–Ω—á–∞ —Å—É—Ä–æ–æ –±–µ—Ä–∏“£–∏–∑...",
                "spinner_thinking": "–û–π–ª–æ–Ω—É—É–¥–∞...",
                "source_expander": "üìù –ö–æ–ª–¥–æ–Ω—É–ª–≥–∞–Ω –ö–æ–Ω—Ç–µ–∫—Å—Ç—Ç–∏–∫ –ë”©–ª“Ø–∫—Ç”©—Ä",
                "source_label": "–ë—É–ª–∞–∫ {j}: {display_name} (–ë–µ—Ç {display_page})",
                "button_new_chat": "–ñ–∞“£—ã –ß–∞—Ç—Ç—ã –ë–∞—à—Ç–æ–æ",
                "warning_disclaimer": "‚ö†Ô∏è **–ê—Ä –¥–∞–π—ã–º –∂–æ–æ–ø—Ç–æ—Ä—É–º–¥—É —Ä–∞—Å–º–∏–π –±—É–ª–∞–∫—Ç–∞—Ä–¥–∞–Ω —Ç–µ–∫—à–µ—Ä–∏“£–∏–∑.**",
                "send_text": "–ñ”©–Ω”©—Ç“Ø“Ø",
                "api_error_message": "API –∫–∞—Ç–∞—Å—ã –ø–∞–π–¥–∞ –±–æ–ª–¥—É. API –∞—á–∫—ã—á—ã“£—ã–∑–¥—ã, —Ç–∞—Ä–º–∞–≥—ã“£—ã–∑–¥—ã –∂–∞–Ω–∞ –±—Ä–∞—É–∑–µ—Ä –∫–æ–Ω—Å–æ–ª—É–Ω —Ç–µ–∫—à–µ—Ä–∏“£–∏–∑. (401 Unauthorized –∫–∞—Ç–∞–ª–∞—Ä—ã–Ω –∫–æ–Ω—Å–æ–ª—É“£—É–∑–¥–∞–Ω —Ç–µ–∫—à–µ—Ä–∏“£–∏–∑).",
            },
        };

        // --- Mapping for Descriptive Names (Localized) ---
        const PDF_NAME_MAP = {
            "05052021_constitution.pdf": {"en": "Constitution of Kyrgyz Republic", "ru": "–ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è –ö—ã—Ä–≥—ã–∑—Å–∫–æ–π –†–µ—Å–ø—É–±–ª–∏–∫–∏", "ky": "–ö—ã—Ä–≥—ã–∑ –†–µ—Å–ø—É–±–ª–∏–∫–∞—Å—ã–Ω—ã–Ω –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è—Å—ã"},
            "07102025_civilcode1.pdf": {"en": "Civil Code (Part 1)", "ru": "–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –∫–æ–¥–µ–∫—Å (—á–∞—Å—Ç—å 1)", "ky": "–ñ–∞—Ä–∞–Ω–¥—ã–∫ –∫–æ–¥–µ–∫—Å (1-–±”©–ª“Ø–∫)"},
            "07022025_civilcode2.pdf": {"en": "Civil Code (Part 2)", "ru": "–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –∫–æ–¥–µ–∫—Å (—á–∞—Å—Ç—å 2)", "ky": "–ñ–∞—Ä–∞–Ω–¥—ã–∫ –∫–æ–¥–µ–∫—Å (2-–±”©–ª“Ø–∫)"},
            "06aug2025_civilprocedurecode.pdf": {"en": "Civil Procedural Code", "ru": "–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—ã–π –∫–æ–¥–µ–∫—Å", "ky": "–ñ–∞—Ä–∞–Ω–¥—ã–∫ –ø—Ä–æ—Ü–µ—Å—Å—Ç–∏–∫ –∫–æ–¥–µ–∫—Å–∏"},
            "10jul2025_labourcode.pdf": {"en": "Labour Code", "ru": "–¢—Ä—É–¥–æ–≤–æ–π –∫–æ–¥–µ–∫—Å", "ky": "–≠–º–≥–µ–∫ –∫–æ–¥–µ–∫—Å–∏"},
            "31jul2025_taxcode.pdf": {"en": "Tax Code", "ru": "–ù–∞–ª–æ–≥–æ–≤—ã–π –∫–æ–¥–µ–∫—Å", "ky": "–°–∞–ª—ã–∫ –∫–æ–¥–µ–∫—Å–∏"},
            "landcode.pdf": {"en": "Land Code", "ru": "–ó–µ–º–µ–ª—å–Ω—ã–π –∫–æ–¥–µ–∫—Å", "ky": "–ñ–µ—Ä –∫–æ–¥–µ–∫—Å–∏"},
            "17jul2025_familycode.pdf": {"en": "Family Code", "ru": "–°–µ–º–µ–π–Ω—ã–π –∫–æ–¥–µ–∫—Å", "ky": "“Æ–π-–±“Ø–ª”© –∫–æ–¥–µ–∫—Å–∏"},
            "28jul2025_penalcode.pdf": {"en": "Criminal Code", "ru": "–£–≥–æ–ª–æ–≤–Ω—ã–π –∫–æ–¥–µ–∫—Å", "ky": "–ö—ã–ª–º—ã—à-–∂–∞–∑–∞ –∫–æ–¥–µ–∫—Å–∏"},
            "09aug2025_crimeprocedurecode.pdf": {"en": "Criminal Procedure Code", "ru": "–£–≥–æ–ª–æ–≤–Ω–æ-–ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—ã–π –∫–æ–¥–µ–∫—Å", "ky": "–ö—ã–ª–º—ã—à-–∂–∞–∑–∞ –ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª–¥—ã–∫ –∫–æ–¥–µ–∫—Å–∏"},
            "31jul2025_crimeexecutivecode.pdf": {"en": "Criminal Execution Code", "ru": "–£–≥–æ–ª–æ–≤–Ω–æ-–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–¥–µ–∫—Å", "ky": "–ñ–∞–∑–∞-–∞—Ç–∫–∞—Ä—É—É –∫–æ–¥–µ–∫—Å–∏"},
            "13aug2025_offencecode.pdf": {"en": "Code of Offenses", "ru": "–ö–æ–¥–µ–∫—Å –æ –ø—Ä–∞–≤–æ–Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö", "ky": "–£–∫—É–∫ –±—É–∑—É—É–ª–∞—Ä –∂”©–Ω“Ø–Ω–¥”© –∫–æ–¥–µ–∫—Å"},
            "28feb2025_adminprocedurecode.pdf": {"en": "Administrative Procedural Code", "ru": "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—ã–π –∫–æ–¥–µ–∫—Å", "ky": "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–¥–∏–∫-–ø—Ä–æ—Ü–µ—Å—Å—Ç–∏–∫ –∫–æ–¥–µ–∫—Å–∏"},
            "01aug2020_kidscode.pdf": {"en": "Children's Code", "ru": "–ö–æ–¥–µ–∫—Å –æ –¥–µ—Ç—è—Ö", "ky": "–ë–∞–ª–¥–∞—Ä –∂”©–Ω“Ø–Ω–¥”© –∫–æ–¥–µ–∫—Å"},
            "29apr2025_budgetcode.pdf": {"en": "Budget Code", "ru": "–ë—é–¥–∂–µ—Ç–Ω—ã–π –∫–æ–¥–µ–∫—Å", "ky": "–ë—é–¥–∂–µ—Ç –∫–æ–¥–µ–∫—Å–∏"},
            "10jul2025_nontaxrevenuecode.pdf": {"en": "Non-Tax Income Code", "ru": "–ö–æ–¥–µ–∫—Å –æ –Ω–µ–Ω–∞–ª–æ–≥–æ–≤—ã—Ö –¥–æ—Ö–æ–¥–∞—Ö", "ky": "–°–∞–ª—ã–∫—Ç—ã–∫ —ç–º–µ—Å –∫–∏—Ä–µ—à–µ–ª–µ—Ä –∂”©–Ω“Ø–Ω–¥”© –∫–æ–¥–µ–∫—Å"},
            "digitalcode.pdf": {"en": "Digital Code", "ru": "–¶–∏—Ñ—Ä–æ–≤–æ–π –∫–æ–¥–µ–∫—Å", "ky": "–°–∞–Ω–∞—Ä–∏–ø –∫–æ–¥–µ–∫—Å–∏"},
            "judicalhonorcode.pdf": {"en": "Code of Ethics For Judges", "ru": "–ö–æ–¥–µ–∫—Å —á–µ—Å—Ç–∏ —Å—É–¥–µ–π", "ky": "–°–æ—Ç—Ç–æ—Ä–¥—É–Ω –∞—Ä-–Ω–∞–º—ã—Å –∫–æ–¥–µ–∫—Å–∏"},
            "tkeaes.pdf": {"en": "Customs Code of the Eurasian Economic Union", "ru": "–¢–∞–º–æ–∂–µ–Ω–Ω—ã–π –∫–æ–¥–µ–∫—Å –ï–≤—Ä–∞–∑–∏–π—Å–∫–æ–≥–æ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—é–∑–∞", "ky": "–ï–≤—Ä–∞–∑–∏—è —ç–∫–æ–Ω–æ–º–∏–∫–∞–ª—ã–∫ –±–∏—Ä–∏–º–¥–∏–≥–∏–Ω–∏–Ω –ë–∞–∂—ã –∫–æ–¥–µ–∫—Å–∏"}
        };

        // List of all possible PDF file names
        const ALL_DOCUMENTS = Object.keys(PDF_NAME_MAP);


        // --- Session State & Globals ---
        let chatHistory = [];
        let currentLanguage = localStorage.getItem('language') || 'en';
        let selectedFiles = Object.keys(PDF_NAME_MAP);
        let currentKValue = 4; // Tracks the retrieval k value

        // --- Translator and Helpers ---
        function T(key, kwargs = {}) {
            const langMap = LANGUAGE_MAPS[currentLanguage] || LANGUAGE_MAPS['en'];
            let text = langMap[key] || LANGUAGE_MAPS['en'][key] || `[MISSING TEXT: ${key}]`;

            // Basic string interpolation
            for (const [k, v] of Object.entries(kwargs)) {
                text = text.replace(`{${k}}`, v);
            }
            return text;
        }

        function getDocDisplayName(fileName) {
            const docMap = PDF_NAME_MAP[fileName] || {};
            return docMap[currentLanguage] || docMap['en'] || fileName;
        }



        // --- UI Rendering ---
        function renderUI() {
            // Update static text elements
            document.getElementById('main-title').textContent = T("main_title");
            document.getElementById('sidebar-header-filter-text').textContent = T("sidebar_header_filter");
            document.getElementById('sidebar-markdown-filter').textContent = T("sidebar_markdown_filter");
            document.getElementById('sidebar-header-retrieval').textContent = T("sidebar_header_retrieval");
            document.getElementById('sidebar-slider-label').textContent = T("sidebar_slider_label");
            document.getElementById('sidebar-header-downloads').textContent = T("sidebar_header_downloads");
            document.getElementById('sidebar-markdown-downloads').textContent = T("sidebar_markdown_downloads");


            document.getElementById('new-chat-button').textContent = T("button_new_chat");
            document.getElementById('chat-input').placeholder = T("chat_input_placeholder");
            document.getElementById('send-text').textContent = T("send_text");

            // Update Custom Language Selector
            const langButton = document.getElementById('lang-selector-button');
            const langOptions = document.getElementById('lang-selector-options');
            langOptions.innerHTML = ''; // Clear previous options

            // Set the button's content to the currently selected language
            const currentLangData = LANGUAGE_MAPS[currentLanguage];
            langButton.innerHTML = `
                <img src="${currentLangData.flag}" alt="${currentLangData.label} flag" width="20" class="mr-2">
                <span>${currentLangData.label}</span>
            `;

            // Populate the options list
            Object.keys(LANGUAGE_MAPS).forEach(langKey => {
                const langData = LANGUAGE_MAPS[langKey];
                const li = document.createElement('li');
                li.dataset.lang = langKey; // Store the language key
                li.innerHTML = `
                    <img src="${langData.flag}" alt="${langData.label} flag" width="20" class="mr-2">
                    <span>${langData.label}</span>
                `;
                langOptions.appendChild(li);
            });

            // Update Document Checkboxes
            const checkboxContainer = document.getElementById('document-checkboxes');
            checkboxContainer.innerHTML = '';

            Object.keys(PDF_NAME_MAP).forEach(fileName => {
                const isChecked = selectedFiles.includes(fileName);
                const displayName = getDocDisplayName(fileName);

                // Use 'flex items-start' for consistent vertical alignment with multiline text
                const div = document.createElement('div');
                div.className = 'flex items-start';

                div.innerHTML = `
                    <input type="checkbox" id="check-${fileName}" value="${fileName}" ${isChecked ? 'checked' : ''} class="w-4 h-4 mt-1 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500 flex-shrink-0">
                    <label for="check-${fileName}" class="ml-2 text-sm font-medium text-gray-300">${displayName}</label>
                `;

                div.querySelector('input').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        selectedFiles.push(fileName);
                    } else {
                        selectedFiles = selectedFiles.filter(f => f !== fileName);
                    }
                    updateSearchingInfo();
                });
                checkboxContainer.appendChild(div);
            });

            // Source Downloads
            const downloadContainer = document.getElementById('download-buttons');
            downloadContainer.innerHTML = '';
            Object.keys(PDF_NAME_MAP).forEach(fileName => {
                const displayName = getDocDisplayName(fileName);
                const link = document.createElement('a'); // Create a link tag
                link.href = `/download/${fileName}`;      // Point to the new endpoint
                link.download = fileName;                 // Tell the browser to download it
                link.className = 'block w-full px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-left text-sm transition duration-150';
                link.textContent = `‚¨áÔ∏è ${displayName}`;
                downloadContainer.appendChild(link);
            });

            // Re-render chat history to apply new language strings
            renderHistory();
        }

        function updateSearchingInfo() {
            const count = selectedFiles.length;
            document.getElementById('sidebar-info-searching').innerHTML = T("sidebar_info_searching", { count: count });
        }

        function renderMessage(role, content, sources = []) {
            const chatArea = document.getElementById('chat-area');
            const isAssistant = role === 'assistant';

            let avatarHtml;
            if (isAssistant) {
                avatarHtml = `<img src="images/kalysicon.png" alt="Kalys Avatar" class="w-10 h-10 object-contain flex-shrink-0">`;
            } else {
                avatarHtml = `<div class="text-2xl flex-shrink-0">üë§</div>`;
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isAssistant ? 'justify-start' : 'justify-end'} items-start`;

            const contentDiv = document.createElement('div');
            contentDiv.className = `max-w-4xl p-4 shadow-lg ${
                isAssistant
                ? 'bg-gray-700 text-gray-100 rounded-xl rounded-tl-none mx-2'
                : 'bg-blue-600 text-white rounded-xl rounded-tr-none mx-2'
            }`;

            let contentHtml;
            if (isAssistant) {
                const warningHtml = `<p class="mb-2 text-yellow-400 text-sm font-medium">${T("warning_disclaimer")}</p><hr class="border-gray-600 mb-2">`;
                contentHtml = content.startsWith(T("spinner_thinking")) ? content : warningHtml + content;
            } else {
                contentHtml = content;
            }

            contentDiv.innerHTML = contentHtml;

            // Add Source Expander (Assistant only, only if sources are present)
            if (isAssistant && sources.length > 0) {
                const expanderTitle = T("source_expander");
                let sourcesHtml = '';
                sources.forEach((source, index) => {
                    // Note: The UI now expects 'uri', 'page', and 'snippet' from the RAG process
                    const sourceFileName = source.uri || 'Unknown Source';
                    const sourcePage = source.page || 'N/A';
                    const displayName = getDocDisplayName(sourceFileName);

                    const label = T("source_label", { j: index + 1, display_name: displayName, display_page: sourcePage });

                    sourcesHtml += `
                        <div class="mt-3">
                            <p class="font-bold text-blue-400 text-xs mb-1">${label}</p>
                            <pre class="source-snippet">${source.snippet}</pre>
                        </div>
                    `;
                });

                // This is the HTML equivalent of the Streamlit expander
                contentDiv.innerHTML += `
                    <details class="mt-4 p-2 bg-gray-600 rounded-lg cursor-pointer">
                        <summary class="font-semibold text-sm">${expanderTitle}</summary>
                        <div class="space-y-3 p-1">
                            ${sourcesHtml}
                        </div>
                    </details>
                `;
            }

            if (isAssistant) {
                messageDiv.innerHTML = avatarHtml;
                messageDiv.appendChild(contentDiv);
            } else {
                messageDiv.appendChild(contentDiv);
                messageDiv.innerHTML += avatarHtml;
            }

            chatArea.appendChild(messageDiv);

            const scrollableContent = document.getElementById('scrollable-content');
            scrollableContent.scrollTop = scrollableContent.scrollHeight;
        }

        function renderHistory() {
            const chatArea = document.getElementById('chat-area');
            chatArea.innerHTML = '';
            chatHistory.forEach(msg => {
                // Ensure we only pass the clean content to renderMessage for re-rendering
                const contentWithoutWarning = msg.role === 'assistant'
                    ? msg.content.replace(T("warning_disclaimer"), '').trim()
                    : msg.content;
                renderMessage(msg.role, contentWithoutWarning, msg.sources);
            });
        }

        // --- Core Chat Logic ---
        async function handleChat(prompt) {
            const inputElement = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const loadingSpinner = document.getElementById('loading-spinner');

            if (!prompt.trim()) return;

            // 1. Add User Message and update history
            renderMessage('user', prompt);
            chatHistory.push({ role: 'user', content: prompt, sources: [] });
            inputElement.value = '';

            // 2. Add temporary loading message and update history
            renderMessage('assistant', T("spinner_thinking"));
            chatHistory.push({ role: 'assistant', content: T("spinner_thinking"), sources: [] });

            // 3. Disable input/button and show spinner
            inputElement.disabled = true;
            sendButton.disabled = true;
            document.getElementById('send-text').classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            let assistantContent = T("api_error_message");
            let sources = [];

            try {
                // --- Fetch from your backend that runs RAG ---
                const ragResponse = await fetch("/rag", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  // Note: You still need to fix the issue where `currentKValue` isn't sent
                  body: JSON.stringify({ question: prompt, history: chatHistory, top_k: currentKValue, filters: selectedFiles })
                }).then(res => res.json());

                // Use the answer and sources directly from your backend
                assistantContent = ragResponse.answer || "‚ö†Ô∏è Error fetching answer from backend.";
                sources = ragResponse.sources || [];


            } catch (error) {
                console.error("Chat Request Error:", error);
                assistantContent = T("api_error_message");
                // Clear the placeholder sources if the API call fails, showing the error is more important
                sources = [];
            } finally {
                // 4. Remove temporary message and Render final Assistant Message
                chatHistory.pop(); // Remove the 'thinking' message

                const chatArea = document.getElementById('chat-area');
                if (chatArea.lastChild) {
                    chatArea.lastChild.remove();
                }

                renderMessage('assistant', assistantContent, sources);
                chatHistory.push({ role: 'assistant', content: assistantContent, sources: sources });

                // 5. Re-enable input/button and hide spinner
                inputElement.disabled = false;
                sendButton.disabled = false;
                document.getElementById('send-text').classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                inputElement.focus();
            }
        }

        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {


            renderUI(); // Initial render of all localized text and checkboxes

            // K-Slider Listener
            const kSlider = document.getElementById('k-slider');
            function updateKValue() {
                currentKValue = kSlider.value;
                document.getElementById('k-value').textContent = currentKValue;
            }
            kSlider.addEventListener('input', updateKValue);
            updateKValue(); // Set initial value display

            // Custom Language Selector Listener
            const langButton = document.getElementById('lang-selector-button');
            const langOptions = document.getElementById('lang-selector-options');

            // Show/hide the dropdown when the button is clicked
            langButton.addEventListener('click', () => {
                langOptions.classList.toggle('hidden');
            });

            // Handle language selection when an option is clicked
            langOptions.addEventListener('click', (e) => {
                const li = e.target.closest('li');
                if (li && li.dataset.lang) {
                    currentLanguage = li.dataset.lang;
                    localStorage.setItem('language', currentLanguage);
                    renderUI(); // Re-render everything with new language
                    langOptions.classList.add('hidden'); // Hide the dropdown after selection
                }
            });

            // Hide dropdown if user clicks outside of it
            document.addEventListener('click', (e) => {
                const selector = document.getElementById('custom-lang-selector');
                if (!selector.contains(e.target)) {
                    langOptions.classList.add('hidden');
                }
            });

            // Send Button Listener
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');

            const sendMessage = () => {
                const prompt = chatInput.value.trim();
                if (prompt) {
                    handleChat(prompt);
                }
            };

            sendButton.addEventListener('click', sendMessage);

            // Input Enter Key Listener
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !sendButton.disabled) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // New Chat Button Listener
            document.getElementById('new-chat-button').addEventListener('click', () => {
                chatHistory = [];
                document.getElementById('chat-area').innerHTML = '';
                chatInput.focus();
            });

            // Set initial focus
            chatInput.focus();

            console.log("Kalys Bot Initialized.");
        });
    </script>
</body>
</html>
